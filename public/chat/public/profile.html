<!-- Version: 1.0056 -->
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª - AMS Chat</title>
  <link rel="manifest" href="../assets/manifest.json">
  <link rel="icon" type="image/png" href="../assets/icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  
  <div class="container mx-auto px-4 py-8 max-w-2xl">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <button onclick="window.location.href='chat.html'" class="text-blue-400 hover:text-blue-300">
        ‚Üê –ù–∞–∑–∞–¥ –∫—ä–º —á–∞—Ç–∞
      </button>
      <h1 class="text-2xl font-bold">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
      <button onclick="logout()" class="text-red-400 hover:text-red-300">
        –ò–∑—Ö–æ–¥
      </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center py-8">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
      <p class="mt-4 text-gray-400">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</p>
    </div>

    <!-- Main Content -->
    <div id="content" class="hidden space-y-6">

      <!-- Basic Info Section -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4 flex items-center justify-between">
          üë§ –û—Å–Ω–æ–≤–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          <span id="editLimitInfo" class="text-sm text-gray-400"></span>
        </h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">–ü—ä–ª–Ω–æ –∏–º–µ</label>
            <input type="text" id="fullName" class="w-full bg-gray-700 rounded px-4 py-2 text-white" />
          </div>

          <div>
            <label class="block text-sm text-gray-400 mb-2">–¢–µ–ª–µ—Ñ–æ–Ω (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–µ–Ω —Ñ–æ—Ä–º–∞—Ç)</label>
            <input type="tel" id="phone" placeholder="+359888123456" class="w-full bg-gray-700 rounded px-4 py-2 text-white" />
          </div>

          <div>
            <label class="block text-sm text-gray-400 mb-2">–î–∞—Ç–∞ –Ω–∞ —Ä–∞–∂–¥–∞–Ω–µ</label>
            <input type="date" id="birthDate" class="w-full bg-gray-700 rounded px-4 py-2 text-white" />
          </div>

          <div>
            <label class="block text-sm text-gray-400 mb-2">–ì—Ä–∞–¥</label>
            <input type="text" id="city" class="w-full bg-gray-700 rounded px-4 py-2 text-white" />
          </div>

          <button onclick="updateProfile()" class="w-full bg-blue-600 hover:bg-blue-700 rounded py-3 font-semibold">
            –ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏ (1 –ø—ä—Ç/–º–µ—Å–µ—Ü)
          </button>
        </div>
      </div>

      <!-- Privacy Settings -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4">üîí –ü–æ–≤–µ—Ä–∏—Ç–µ–ª–Ω–æ—Å—Ç</h2>
        
        <div class="space-y-4">
          <label class="flex items-center justify-between cursor-pointer">
            <span>–°–∫—Ä–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω–µ–Ω –Ω–æ–º–µ—Ä</span>
            <input type="checkbox" id="hidePhone" onchange="toggleHidePhone()" class="w-6 h-6" />
          </label>

          <label class="flex items-center justify-between cursor-pointer">
            <span>–°–∫—Ä–∏–π –∏–º–µ–Ω–∞</span>
            <input type="checkbox" id="hideNames" onchange="toggleHideNames()" class="w-6 h-6" />
          </label>
        </div>
      </div>

      <!-- Security Section -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4">üîê –°–∏–≥—É—Ä–Ω–æ—Å—Ç</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">–ö–æ–¥–æ–≤–∞ –¥—É–º–∞ (–∑–∞ —Ç–æ—á–Ω–æ —Ç—ä—Ä—Å–µ–Ω–µ)</label>
            <input type="text" id="codeWord" class="w-full bg-gray-700 rounded px-4 py-2 text-white" />
            <p class="text-xs text-gray-500 mt-1">–î—Ä—É–≥–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ —Ç—Ä—è–±–≤–∞ –¥–∞ –∑–Ω–∞—è—Ç —Ç–∞–∑–∏ –¥—É–º–∞, –∑–∞ –¥–∞ —Ç–µ –Ω–∞–º–µ—Ä—è—Ç —Ç–æ—á–Ω–æ</p>
          </div>

          <button onclick="updateCodeWord()" class="w-full bg-green-600 hover:bg-green-700 rounded py-2">
            –û–±–Ω–æ–≤–∏ –∫–æ–¥–æ–≤–∞ –¥—É–º–∞
          </button>

          <hr class="border-gray-700" />

          <div>
            <label class="block text-sm text-gray-400 mb-2">Email –∞–¥—Ä–µ—Å</label>
            <input type="email" id="email" class="w-full bg-gray-700 rounded px-4 py-2 text-white" />
          </div>

          <button onclick="updateEmail()" class="w-full bg-green-600 hover:bg-green-700 rounded py-2">
            –û–±–Ω–æ–≤–∏ email
          </button>

          <hr class="border-gray-700" />

          <div>
            <label class="block text-sm text-gray-400 mb-2">–¢–µ–∫—É—â–∞ –ø–∞—Ä–æ–ª–∞</label>
            <input type="password" id="currentPassword" class="w-full bg-gray-700 rounded px-4 py-2 text-white" />
          </div>

          <div>
            <label class="block text-sm text-gray-400 mb-2">–ù–æ–≤–∞ –ø–∞—Ä–æ–ª–∞</label>
            <input type="password" id="newPassword" class="w-full bg-gray-700 rounded px-4 py-2 text-white" />
          </div>

          <button onclick="updatePassword()" class="w-full bg-green-600 hover:bg-green-700 rounded py-2">
            –°–º–µ–Ω–∏ –ø–∞—Ä–æ–ª–∞
          </button>
        </div>
      </div>

      <!-- Current Need Section -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4">üîç –¢–µ–∫—É—â–∞ –Ω—É–∂–¥–∞</h2>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">–û—Ç –∫–∞–∫–≤–æ –∏–º–∞–º –Ω—É–∂–¥–∞ —Å–µ–≥–∞?</label>
            <select id="needCategory" onchange="updateNeedSubcategories()" class="w-full bg-gray-700 rounded px-4 py-2 text-white">
              <option value="">-- –ò–∑–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è --</option>
            </select>
          </div>

          <div id="needSubcategoryContainer" class="hidden">
            <label class="block text-sm text-gray-400 mb-2">–¢–æ—á–Ω–∞ –Ω—É–∂–¥–∞</label>
            <select id="needSubcategory" class="w-full bg-gray-700 rounded px-4 py-2 text-white">
              <option value="">-- –ò–∑–±–µ—Ä–∏ --</option>
            </select>
          </div>

          <button onclick="updateNeed()" class="w-full bg-blue-600 hover:bg-blue-700 rounded py-2">
            –û–±–Ω–æ–≤–∏ –Ω—É–∂–¥–∞
          </button>
        </div>
      </div>

      <!-- Offerings Section -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4">üíº –ö–∞–∫–≤–æ –ø—Ä–µ–¥–ª–∞–≥–∞–º (–º–∞–∫—Å 3)</h2>
        
        <div id="verifiedLock" class="hidden bg-yellow-900 border border-yellow-600 rounded p-4 mb-4">
          <p class="text-yellow-300">üîí –í–∞—à–∏—è—Ç –ø—Ä–æ—Ñ–∏–ª –µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–∞–Ω. –ü–æ–ª–µ—Ç–æ "–ü—Ä–µ–¥–ª–∞–≥–∞–º" –µ –∑–∞–∫–ª—é—á–µ–Ω–æ.</p>
          <p class="text-sm text-yellow-400 mt-2">–ó–∞ –ø—Ä–æ–º–µ–Ω–∏: <a href="mailto:admin@amschat.com" class="underline">admin@amschat.com</a></p>
        </div>

        <div id="offeringsForm" class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">–£—Å–ª—É–≥–∞ 1</label>
            <select id="offering1Category" onchange="updateOfferingSubcategories(1)" class="w-full bg-gray-700 rounded px-4 py-2 text-white mb-2">
              <option value="">-- –ò–∑–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è --</option>
            </select>
            <select id="offering1" class="w-full bg-gray-700 rounded px-4 py-2 text-white">
              <option value="">-- –ò–∑–±–µ—Ä–∏ —É—Å–ª—É–≥–∞ --</option>
            </select>
          </div>

          <div>
            <label class="block text-sm text-gray-400 mb-2">–£—Å–ª—É–≥–∞ 2 (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)</label>
            <select id="offering2Category" onchange="updateOfferingSubcategories(2)" class="w-full bg-gray-700 rounded px-4 py-2 text-white mb-2">
              <option value="">-- –ò–∑–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è --</option>
            </select>
            <select id="offering2" class="w-full bg-gray-700 rounded px-4 py-2 text-white">
              <option value="">-- –ò–∑–±–µ—Ä–∏ —É—Å–ª—É–≥–∞ --</option>
            </select>
          </div>

          <div>
            <label class="block text-sm text-gray-400 mb-2">–£—Å–ª—É–≥–∞ 3 (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)</label>
            <select id="offering3Category" onchange="updateOfferingSubcategories(3)" class="w-full bg-gray-700 rounded px-4 py-2 text-white mb-2">
              <option value="">-- –ò–∑–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è --</option>
            </select>
            <select id="offering3" class="w-full bg-gray-700 rounded px-4 py-2 text-white">
              <option value="">-- –ò–∑–±–µ—Ä–∏ —É—Å–ª—É–≥–∞ --</option>
            </select>
          </div>

          <div class="bg-blue-900 border border-blue-600 rounded p-4">
            <p class="text-blue-300 text-sm">‚ÑπÔ∏è –ó–∞ —Å–ø–µ—à–Ω–∏ —É—Å–ª—É–≥–∏ (–î–æ–∫—Ç–æ—Ä, –ë–æ–ª–Ω–∏—Ü–∞, –ë—ä—Ä–∑–∞ –ø–æ–º–æ—â, –ü–æ–ª–∏—Ü–∏—è) –∏–∑–ø—Ä–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –Ω–∞:</p>
            <p class="text-blue-200 mt-1"><a href="mailto:admin@amschat.com" class="underline font-semibold">admin@amschat.com</a></p>
          </div>

          <button onclick="updateOfferings()" class="w-full bg-blue-600 hover:bg-blue-700 rounded py-2">
            –ó–∞–ø–∞–∑–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–Ω–∏—è
          </button>
        </div>
      </div>

      <!-- Payment Section -->
      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4">üí≥ –ê–±–æ–Ω–∞–º–µ–Ω—Ç</h2>
        
        <div id="subscriptionInfo" class="space-y-3">
          <div class="flex justify-between">
            <span class="text-gray-400">–°—Ç–∞—Ç—É—Å:</span>
            <span id="subscriptionStatus" class="font-semibold"></span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-400">–í–∞–ª–∏–¥–µ–Ω –¥–æ:</span>
            <span id="paidUntil" class="font-semibold"></span>
          </div>
        </div>

        <button onclick="window.location.href='payment.html'" class="w-full bg-green-600 hover:bg-green-700 rounded py-3 mt-4 font-semibold">
          üí∞ –ü–ª–∞—Ç–∏ –∞–±–æ–Ω–∞–º–µ–Ω—Ç
        </button>
      </div>

      <!-- Emergency Help Button -->
      <div class="bg-red-900 border border-red-600 rounded-lg p-6">
        <h2 class="text-xl font-bold mb-4">üÜò –°–ø–µ—à–Ω–∞ –ø–æ–º–æ—â</h2>
        
        <div id="helpButtonInfo" class="space-y-3 mb-4 text-sm">
          <p>–ë—É—Ç–æ–Ω—ä—Ç –∏–∑–ø—Ä–∞—â–∞ –≤–∞—à–∞—Ç–∞ —Ç–æ—á–Ω–∞ –ª–æ–∫–∞—Ü–∏—è –¥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</p>
          <p><strong>–¶–µ–Ω–∞:</strong> <span id="helpCost"></span></p>
          <p><strong>–ï—Ñ–µ–∫—Ç:</strong> –û—Ç–Ω–µ–º–∞ 15 –¥–Ω–∏ –æ—Ç –∞–±–æ–Ω–∞–º–µ–Ω—Ç–∞</p>
          <p><strong>–õ–∏–º–∏—Ç:</strong> 1 –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ –Ω–∞ –º–µ—Å–µ—Ü</p>
        </div>

        <button id="helpButton" onclick="sendEmergencyHelp()" class="w-full bg-red-600 hover:bg-red-700 rounded py-4 font-bold text-lg disabled:bg-gray-600 disabled:cursor-not-allowed">
          üö® –ò–ó–ü–†–ê–¢–ò –°–ü–ï–®–ù–ê –ü–û–ú–û–©
        </button>

        <p id="helpUsageInfo" class="text-xs text-gray-400 mt-2 text-center"></p>
      </div>

    </div>
  </div>

  <script src="/configs/config.js"></script>
  <script>
    let serviceCategories = {};
    let profileData = {};

    // Load profile on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadServiceCategories();
      await loadProfile();
      await checkHelpButtonAvailability();
    });

    async function loadServiceCategories() {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_URL}/profile/service-categories`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        serviceCategories = data.all;
        
        // Populate need category dropdown
        const needCat = document.getElementById('needCategory');
        Object.keys(serviceCategories).forEach(key => {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = serviceCategories[key].label;
          needCat.appendChild(opt);
        });

        // Populate offering category dropdowns (exclude EMERGENCY)
        [1, 2, 3].forEach(i => {
          const offeringCat = document.getElementById(`offering${i}Category`);
          Object.keys(serviceCategories).forEach(key => {
            if (key !== 'EMERGENCY') { // Can't select emergency services
              const opt = document.createElement('option');
              opt.value = key;
              opt.textContent = serviceCategories[key].label;
              offeringCat.appendChild(opt);
            }
          });
        });
        
      } catch (err) {
        console.error('Load categories error:', err);
      }
    }

    async function loadProfile() {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_URL}/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!res.ok) throw new Error('Failed to load profile');
        
        profileData = await res.json();
        
        // Fill form
        document.getElementById('fullName').value = profileData.full_name || '';
        document.getElementById('phone').value = profileData.phone || '';
        document.getElementById('birthDate').value = profileData.birth_date || '';
        document.getElementById('city').value = profileData.city || '';
        document.getElementById('codeWord').value = profileData.code_word || '';
        document.getElementById('email').value = profileData.email || '';
        document.getElementById('hidePhone').checked = profileData.hide_phone === 1;
        document.getElementById('hideNames').checked = profileData.hide_names === 1;

        // Subscription info
        const paidUntil = new Date(profileData.paid_until);
        const isActive = paidUntil > new Date();
        document.getElementById('subscriptionStatus').textContent = isActive ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ò–∑—Ç–µ–∫—ä–ª';
        document.getElementById('subscriptionStatus').className = isActive ? 'text-green-400 font-semibold' : 'text-red-400 font-semibold';
        document.getElementById('paidUntil').textContent = paidUntil.toLocaleDateString('bg-BG');

        // Offerings
        if (profileData.is_verified === 1) {
          document.getElementById('verifiedLock').classList.remove('hidden');
          document.getElementById('offeringsForm').classList.add('hidden');
        } else {
          if (profileData.offerings) {
            const offerings = profileData.offerings.split(',').map(s => s.trim());
            offerings.forEach((offering, idx) => {
              if (idx < 3) {
                document.getElementById(`offering${idx + 1}`).value = offering;
              }
            });
          }
        }

        // Current need
        if (profileData.current_need) {
          // Find which category this need belongs to
          for (const [catKey, catData] of Object.entries(serviceCategories)) {
            if (catData.subcategories.includes(profileData.current_need)) {
              document.getElementById('needCategory').value = catKey;
              updateNeedSubcategories();
              document.getElementById('needSubcategory').value = profileData.current_need;
              break;
            }
          }
        }

        // Edit limit info
        const editsRemaining = 1 - (profileData.profile_edits_this_month || 0);
        document.getElementById('editLimitInfo').textContent = `–†–µ–¥–∞–∫—Ü–∏–∏ –æ—Å—Ç–∞–Ω–∞–ª–∏: ${editsRemaining}/1`;

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
        
      } catch (err) {
        console.error('Load profile error:', err);
        alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞');
      }
    }

    function updateNeedSubcategories() {
      const category = document.getElementById('needCategory').value;
      const container = document.getElementById('needSubcategoryContainer');
      const select = document.getElementById('needSubcategory');
      
      if (!category) {
        container.classList.add('hidden');
        return;
      }
      
      container.classList.remove('hidden');
      select.innerHTML = '<option value="">-- –ò–∑–±–µ—Ä–∏ --</option>';
      
      serviceCategories[category].subcategories.forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub;
        select.appendChild(opt);
      });
    }

    function updateOfferingSubcategories(num) {
      const category = document.getElementById(`offering${num}Category`).value;
      const select = document.getElementById(`offering${num}`);
      
      select.innerHTML = '<option value="">-- –ò–∑–±–µ—Ä–∏ —É—Å–ª—É–≥–∞ --</option>';
      
      if (!category) return;
      
      serviceCategories[category].subcategories.forEach(sub => {
        const opt = document.createElement('option');
        opt.value = sub;
        opt.textContent = sub;
        select.appendChild(opt);
      });
    }

    async function updateProfile() {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_URL}/profile`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            full_name: document.getElementById('fullName').value,
            phone: document.getElementById('phone').value,
            birth_date: document.getElementById('birthDate').value,
            city: document.getElementById('city').value
          })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          alert(data.error || '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ');
          return;
        }
        
        alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—ä—Ç –µ –æ–±–Ω–æ–≤–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
        await loadProfile();
        
      } catch (err) {
        console.error('Update profile error:', err);
        alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞');
      }
    }

    async function toggleHidePhone() {
      const hide = document.getElementById('hidePhone').checked;
      await updateSetting('/profile/hide-phone', { hide_phone: hide });
    }

    async function toggleHideNames() {
      const hide = document.getElementById('hideNames').checked;
      await updateSetting('/profile/hide-names', { hide_names: hide });
    }

    async function updateCodeWord() {
      const codeWord = document.getElementById('codeWord').value;
      if (!codeWord || codeWord.length < 3) {
        alert('–ö–æ–¥–æ–≤–∞—Ç–∞ –¥—É–º–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –ø–æ–Ω–µ 3 —Å–∏–º–≤–æ–ª–∞');
        return;
      }
      await updateSetting('/profile/code-word', { code_word: codeWord }, '–ö–æ–¥–æ–≤–∞—Ç–∞ –¥—É–º–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞');
    }

    async function updateEmail() {
      const email = document.getElementById('email').value;
      await updateSetting('/profile/email', { email }, 'Email-—ä—Ç –µ –æ–±–Ω–æ–≤–µ–Ω');
    }

    async function updatePassword() {
      const current = document.getElementById('currentPassword').value;
      const newPass = document.getElementById('newPassword').value;
      
      if (!current || !newPass) {
        alert('–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∏ –¥–≤–µ—Ç–µ –ø–æ–ª–µ—Ç–∞');
        return;
      }
      
      await updateSetting('/profile/password', {
        current_password: current,
        new_password: newPass
      }, '–ü–∞—Ä–æ–ª–∞—Ç–∞ –µ —Å–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
      
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
    }

    async function updateNeed() {
      const need = document.getElementById('needSubcategory').value;
      await updateSetting('/profile/need', { current_need: need }, '–ù—É–∂–¥–∞—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞');
    }

    async function updateOfferings() {
      const offerings = [
        document.getElementById('offering1').value,
        document.getElementById('offering2').value,
        document.getElementById('offering3').value
      ].filter(Boolean).join(',');
      
      await updateSetting('/profile/offerings', { offerings }, '–ü—Ä–µ–¥–ª–∞–≥–∞–Ω–∏—è—Ç–∞ —Å–∞ –æ–±–Ω–æ–≤–µ–Ω–∏');
    }

    async function updateSetting(endpoint, body, successMsg = '–û–±–Ω–æ–≤–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ') {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_URL}${endpoint}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          alert(data.error || '–ì—Ä–µ—à–∫–∞');
          return;
        }
        
        alert('‚úÖ ' + successMsg);
        
      } catch (err) {
        console.error('Update error:', err);
        alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ');
      }
    }

    async function checkHelpButtonAvailability() {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_URL}/help/availability`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const data = await res.json();
        
        document.getElementById('helpCost').textContent = `${data.charge.currency.toUpperCase()} ${data.charge.amount}`;
        
        const button = document.getElementById('helpButton');
        button.disabled = !data.available;
        
        if (!data.available) {
          let reason = '';
          if (!data.has_subscription) reason = '–ù—è–º–∞—Ç–µ –∞–∫—Ç–∏–≤–µ–Ω –∞–±–æ–Ω–∞–º–µ–Ω—Ç';
          else if (data.uses_this_month >= 1) reason = `–í–µ—á–µ –µ –∏–∑–ø–æ–ª–∑–≤–∞–Ω —Ç–æ–∑–∏ –º–µ—Å–µ—Ü. –°–ª–µ–¥–≤–∞—â–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–µ: ${new Date(data.next_reset).toLocaleDateString('bg-BG')}`;
          
          document.getElementById('helpUsageInfo').textContent = reason;
        } else {
          document.getElementById('helpUsageInfo').textContent = `–û—Å—Ç–∞–≤–∞—Ç: ${data.remaining_uses} –∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏—è`;
        }
        
      } catch (err) {
        console.error('Check help availability error:', err);
      }
    }

    async function sendEmergencyHelp() {
      if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–¢–æ–≤–∞ —â–µ –∏–∑–ø—Ä–∞—Ç–∏ –≤–∞—à–∞—Ç–∞ —Ç–æ—á–Ω–∞ –ª–æ–∫–∞—Ü–∏—è –¥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏ —â–µ –≤–∏ —Å—Ç—Ä—É–≤–∞ ‚Ç¨50/$50 (15 –¥–Ω–∏ –æ—Ç –∞–±–æ–Ω–∞–º–µ–Ω—Ç–∞).\n\n–ü—Ä–æ–¥—ä–ª–∂–∞–≤–∞—Ç–µ?')) {
        return;
      }
      
      // Get GPS location
      if (!navigator.geolocation) {
        alert('–í–∞—à–∏—è—Ç –±—Ä–∞—É–∑—ä—Ä –Ω–µ –ø–æ–¥–¥—ä—Ä–∂–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(async (position) => {
        try {
          const token = localStorage.getItem('token');
          const res = await fetch(`${API_URL}/help/emergency`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              latitude: position.coords.latitude,
              longitude: position.coords.longitude
            })
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            alert(data.error || '–ì—Ä–µ—à–∫–∞');
            return;
          }
          
          alert(`‚úÖ –°–ø–µ—à–Ω–∞ –ø–æ–º–æ—â –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞!\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ä—Ç –µ —É–≤–µ–¥–æ–º–µ–Ω —Å –≤–∞—à–∞—Ç–∞ –ª–æ–∫–∞—Ü–∏—è.\n\n–ò–î –Ω–∞ –∑–∞—è–≤–∫–∞—Ç–∞: ${data.request_id}`);
          
          await loadProfile();
          await checkHelpButtonAvailability();
          
        } catch (err) {
          console.error('Emergency help error:', err);
          alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –ø–æ–º–æ—â');
        }
      }, (error) => {
        alert('–ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –ø–æ–ª—É—á–∏ –ª–æ–∫–∞—Ü–∏—è: ' + error.message);
      }, {
        enableHighAccuracy: true,
        timeout: 10000
      });
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    }
  </script>

</body>
</html>
