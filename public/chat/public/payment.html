<!-- Version: 1.0056 -->
<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∞—â–∞–Ω–µ - –ê–Ω–æ–Ω–∏–º–µ–Ω –ß–∞—Ç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <!-- Load config first -->
    <script src="/configs/config.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-2">üí≥ –ü–ª–∞—â–∞–Ω–µ</h1>
            <p class="text-gray-400">–ò–∑–±–µ—Ä–∏ –º–µ—Ç–æ–¥ –Ω–∞ –ø–ª–∞—â–∞–Ω–µ</p>
        </div>

        <!-- Payment Options -->
        <div class="bg-gray-800 rounded-lg p-6 space-y-4">
            <!-- Crypto Payment (KCY1) -->
            <div class="border border-purple-500 rounded-lg p-6 bg-gradient-to-br from-purple-900/20 to-blue-900/20">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-purple-400">ü™ô Crypto –ü–ª–∞—â–∞–Ω–µ</h3>
                        <p class="text-sm text-gray-400">–ü–ª–∞—Ç–∏ —Å KCY1 —Ç–æ–∫–µ–Ω</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-purple-300" id="cryptoAmount">300 KCY</div>
                        <div class="text-sm text-gray-400">‚âà $0.026*</div>
                    </div>
                </div>

                <div id="walletSection">
                    <!-- Not Connected -->
                    <div id="notConnected" class="space-y-3">
                        <button 
                            id="connectWalletBtn"
                            class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded font-bold flex items-center justify-center gap-2"
                        >
                            <span>ü¶ä</span>
                            <span>–°–≤—ä—Ä–∂–∏ MetaMask</span>
                        </button>
                        <p class="text-xs text-gray-500 text-center">
                            –©–µ —Ç–∏ —Ç—Ä—è–±–≤–∞ MetaMask wallet —Å <span id="networkName">BSC Mainnet</span>
                        </p>
                    </div>

                    <!-- Connected -->
                    <div id="connected" class="hidden space-y-3">
                        <div class="bg-gray-900/50 rounded p-3 text-sm">
                            <div class="text-gray-400 mb-1">–°–≤—ä—Ä–∑–∞–Ω –ø–æ—Ä—Ç—Ñ–µ–π–ª:</div>
                            <div id="walletAddress" class="font-mono text-green-400"></div>
                        </div>

                        <div class="bg-gray-900/50 rounded p-3 text-sm">
                            <div class="text-gray-400 mb-1">–ë–∞–ª–∞–Ω—Å:</div>
                            <div id="tokenBalance" class="font-bold text-yellow-400">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
                        </div>

                        <button 
                            id="payWithCryptoBtn"
                            class="w-full bg-green-600 hover:bg-green-700 py-3 rounded font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            –ü–ª–∞—Ç–∏ <span id="paymentAmount">300 KCY</span>
                        </button>

                        <button 
                            id="disconnectBtn"
                            class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm"
                        >
                            –ò–∑–∫–ª—é—á–∏ –ø–æ—Ä—Ç—Ñ–µ–π–ª
                        </button>
                    </div>
                </div>

                <div class="mt-4 text-xs text-gray-500">
                    * –ü—Ä–∏ —Ü–µ–Ω–∞ $0.000088 (30x). –ê–∫—Ç—É–∞–ª–Ω–∞—Ç–∞ —Ü–µ–Ω–∞ –∑–∞–≤–∏—Å–∏ –æ—Ç –ø–∞–∑–∞—Ä–∞.
                </div>
            </div>

            <!-- Divider -->
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-700"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-gray-800 text-gray-400">–ò–õ–ò</span>
                </div>
            </div>

            <!-- Card Payment (Stripe) -->
            <div class="border border-blue-500 rounded-lg p-6 bg-gradient-to-br from-blue-900/20 to-cyan-900/20">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-blue-400">üí≥ –ö–∞—Ä—Ç–∞</h3>
                        <p class="text-sm text-gray-400">Visa/Mastercard</p>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-blue-300" id="cardPrice">‚Ç¨5</div>
                        <div class="text-sm text-gray-400">–∏–ª–∏ $5</div>
                    </div>
                </div>

                <button 
                    id="payWithCardBtn"
                    class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded font-bold"
                >
                    –ü–ª–∞—Ç–∏ —Å –∫–∞—Ä—Ç–∞
                </button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="mt-4 text-center hidden">
            <div class="bg-gray-800 rounded p-4">
                <div id="statusText" class="text-gray-300"></div>
            </div>
        </div>

        <!-- Back to Login -->
        <div class="mt-6 text-center">
            <a href="/index.html" class="text-gray-400 hover:text-white text-sm">
                ‚Üê –ù–∞–∑–∞–¥ –∫—ä–º –≤—Ö–æ–¥
            </a>
        </div>
    </div>

    <script>
        // Load configuration from global config file
        const config = window.CRYPTO_CONFIG;
        const network = window.getCurrentNetwork();
        
        // Use config values
        const KCY1_TOKEN_ADDRESS = config.TOKEN_ADDRESS;
        const TREASURY_WALLET = config.TREASURY_WALLET;
        const PAYMENT_AMOUNT = config.PAYMENT_AMOUNT;
        const BSC_CHAIN_ID = network.CHAIN_ID;
        const BSC_RPC_URL = network.RPC_URL;
        const EXPLORER_URL = network.EXPLORER_URL;

        // Update UI with config values
        document.getElementById('networkName').textContent = network.CHAIN_NAME;
        document.getElementById('cryptoAmount').textContent = `${PAYMENT_AMOUNT} KCY`;
        document.getElementById('paymentAmount').textContent = `${PAYMENT_AMOUNT} KCY`;

        // ERC20 Token ABI (minimal)
        const TOKEN_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function transfer(address to, uint256 amount) returns (bool)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)"
        ];

        let provider = null;
        let signer = null;
        let userAddress = null;
        let tokenContract = null;

        // Get user info from storage
        const userId = localStorage.getItem('userId');
        const userPhone = localStorage.getItem('userPhone');

        if (!userId) {
            window.location.href = '/index.html';
        }

        // Connect Wallet
        document.getElementById('connectWalletBtn').addEventListener('click', async () => {
            await connectWallet();
        });

        // Disconnect Wallet
        document.getElementById('disconnectBtn').addEventListener('click', () => {
            disconnectWallet();
        });

        // Pay with Crypto
        document.getElementById('payWithCryptoBtn').addEventListener('click', async () => {
            await payWithCrypto();
        });

        // Pay with Card
        document.getElementById('payWithCardBtn').addEventListener('click', () => {
            showStatus('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ Stripe –ø–ª–∞—â–∞–Ω–µ...', 'info');
            // TODO: Implement Stripe flow
            alert('Stripe –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è - –¢—Ä—è–±–≤–∞ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ Stripe checkout flow —Ç—É–∫');
        });

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('MetaMask –Ω–µ –µ –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω! –ú–æ–ª—è –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞–π –æ—Ç metamask.io');
                    return;
                }

                showStatus('üîå –°–≤—ä—Ä–∑–≤–∞–Ω–µ —Å MetaMask...', 'info');

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();

                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== BSC_CHAIN_ID) {
                    showStatus(`‚ö†Ô∏è –ú–æ–ª—è –ø—Ä–µ–≤–∫–ª—é—á–∏ –Ω–∞ ${network.CHAIN_NAME} –≤ MetaMask`, 'warning');
                    await switchToBSC();
                    return;
                }

                tokenContract = new ethers.Contract(KCY1_TOKEN_ADDRESS, TOKEN_ABI, signer);

                await updateBalance();

                document.getElementById('notConnected').classList.add('hidden');
                document.getElementById('connected').classList.remove('hidden');
                document.getElementById('walletAddress').textContent = 
                    userAddress.substring(0, 6) + '...' + userAddress.substring(38);

                showStatus('‚úÖ –ü–æ—Ä—Ç—Ñ–µ–π–ª —Å–≤—ä—Ä–∑–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                setTimeout(() => hideStatus(), 2000);

            } catch (error) {
                console.error('Connect error:', error);
                showStatus('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ: ' + error.message, 'error');
            }
        }

        function disconnectWallet() {
            userAddress = null;
            provider = null;
            signer = null;
            tokenContract = null;

            document.getElementById('connected').classList.add('hidden');
            document.getElementById('notConnected').classList.remove('hidden');
            
            showStatus('üîå –ü–æ—Ä—Ç—Ñ–µ–π–ª –∏–∑–∫–ª—é—á–µ–Ω', 'info');
            setTimeout(() => hideStatus(), 2000);
        }

        async function updateBalance() {
            try {
                const balance = await tokenContract.balanceOf(userAddress);
                const decimals = await tokenContract.decimals();
                const symbol = await tokenContract.symbol();
                
                const formattedBalance = ethers.utils.formatUnits(balance, decimals);
                
                document.getElementById('tokenBalance').textContent = 
                    `${parseFloat(formattedBalance).toFixed(2)} ${symbol}`;

                const requiredAmount = ethers.utils.parseUnits(PAYMENT_AMOUNT, decimals);
                const hasEnough = balance.gte(requiredAmount);

                const payBtn = document.getElementById('payWithCryptoBtn');
                payBtn.disabled = !hasEnough;

                if (!hasEnough) {
                    payBtn.textContent = '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–µ–Ω –±–∞–ª–∞–Ω—Å';
                } else {
                    payBtn.innerHTML = `–ü–ª–∞—Ç–∏ <span id="paymentAmount">${PAYMENT_AMOUNT} KCY</span>`;
                }

            } catch (error) {
                console.error('Balance error:', error);
                document.getElementById('tokenBalance').textContent = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ';
            }
        }

        async function switchToBSC() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BSC_CHAIN_ID }],
                });
                
                setTimeout(() => connectWallet(), 1000);
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BSC_CHAIN_ID,
                                chainName: network.CHAIN_NAME,
                                nativeCurrency: {
                                    name: network.CURRENCY.NAME,
                                    symbol: network.CURRENCY.SYMBOL,
                                    decimals: network.CURRENCY.DECIMALS
                                },
                                rpcUrls: [BSC_RPC_URL],
                                blockExplorerUrls: [EXPLORER_URL]
                            }],
                        });
                        setTimeout(() => connectWallet(), 1000);
                    } catch (addError) {
                        showStatus('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ BSC network', 'error');
                    }
                }
            }
        }

        async function payWithCrypto() {
            try {
                const payBtn = document.getElementById('payWithCryptoBtn');
                payBtn.disabled = true;
                payBtn.textContent = '‚è≥ –ò–∑–ø—Ä–∞—â–∞–Ω–µ...';

                showStatus('üìù –ú–æ–ª—è –ø–æ—Ç–≤—ä—Ä–¥–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ç–∞ –≤ MetaMask...', 'info');

                const decimals = await tokenContract.decimals();
                const amount = ethers.utils.parseUnits(PAYMENT_AMOUNT, decimals);

                const tx = await tokenContract.transfer(TREASURY_WALLET, amount);
                
                showStatus('‚è≥ –ò–∑—á–∞–∫–≤–∞–Ω–µ –Ω–∞ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ...', 'info');
                
                const receipt = await tx.wait();

                showStatus('‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –û–±—Ä–∞–±–æ—Ç–≤–∞–Ω–µ –Ω–∞ –ø–ª–∞—â–∞–Ω–µ—Ç–æ...', 'success');

                await notifyBackendPayment(tx.hash, userAddress);

            } catch (error) {
                console.error('Payment error:', error);
                
                let errorMsg = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø–ª–∞—â–∞–Ω–µ—Ç–æ';
                if (error.code === 4001) {
                    errorMsg = '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ç–∞ –±–µ—à–µ –æ—Ç–∫–∞–∑–∞–Ω–∞';
                } else if (error.message) {
                    errorMsg = error.message;
                }
                
                showStatus('‚ùå ' + errorMsg, 'error');
                
                const payBtn = document.getElementById('payWithCryptoBtn');
                payBtn.disabled = false;
                payBtn.innerHTML = `–ü–ª–∞—Ç–∏ <span id="paymentAmount">${PAYMENT_AMOUNT} KCY</span>`;
            }
        }

        async function notifyBackendPayment(txHash, walletAddress) {
            try {
                const response = await fetch('/api/payment/crypto-confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        phone: userPhone,
                        txHash: txHash,
                        walletAddress: walletAddress,
                        amount: PAYMENT_AMOUNT,
                        tokenAddress: KCY1_TOKEN_ADDRESS
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showStatus('üéâ –ü–ª–∞—â–∞–Ω–µ—Ç–æ –µ –ø–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ! –í–ª–∏–∑–∞–Ω–µ...', 'success');
                    
                    localStorage.setItem('token', data.token);
                    
                    setTimeout(() => {
                        window.location.href = '/chat.html';
                    }, 2000);
                } else {
                    showStatus('‚ö†Ô∏è ' + (data.error || '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ'), 'warning');
                }
            } catch (error) {
                console.error('Backend notify error:', error);
                showStatus('‚ö†Ô∏è –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ç–∞ –µ —É—Å–ø–µ—à–Ω–∞, –Ω–æ –∏–º–∞ –ø—Ä–æ–±–ª–µ–º —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞. –ú–æ–ª—è –æ–ø–∏—Ç–∞–π –¥–∞ –≤–ª–µ–∑–µ—à —Å–ª–µ–¥ –º–∏–Ω—É—Ç–∞.', 'warning');
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = message;
            statusDiv.classList.remove('hidden');

            statusDiv.className = 'mt-4 text-center';
            if (type === 'success') {
                statusText.className = 'text-green-400';
            } else if (type === 'error') {
                statusText.className = 'text-red-400';
            } else if (type === 'warning') {
                statusText.className = 'text-yellow-400';
            } else {
                statusText.className = 'text-gray-300';
            }
        }

        function hideStatus() {
            document.getElementById('statusMessage').classList.add('hidden');
        }

        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else {
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
